<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HANSORA • Midjourney (Image → Video) • Telegram Mini App</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='24' fill='%2313121f'/%3E%3Ctext x='50' y='58' text-anchor='middle' font-size='42' fill='white' font-family='Arial'%3EH%3C/text%3E%3C/svg%3E" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --base-bg:#0b0d13; --base-line:#1a1f2b; --brand:#6366f1; }
    body{
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(99,102,241,.15), transparent 60%),
        radial-gradient(1200px 600px at 100% 100%, rgba(56,189,248,.12), transparent 60%),
        var(--base-bg);
      color:#e5e7eb;
    }
    .bg-base-bg{background:var(--base-bg)}
    .border-base-line{border-color:var(--base-line)}
    .shadow-soft{box-shadow:0 18px 45px rgba(0,0,0,.55)}
    .btn{background:linear-gradient(135deg,#6366f1,#22c1c3);color:white;font-weight:600}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .input-dark{
      background:rgba(15,23,42,.85);
      border-color:rgba(148,163,184,.35);
    }
    .input-dark:focus{
      border-color:rgba(129,140,248,1);
      box-shadow:0 0 0 1px rgba(129,140,248,.6);
    }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-base-bg">
  <!-- Header (no login, no nav; shows credits from URL) -->
  <header class="sticky top-0 z-40 border-b border-base-line/60 bg-base-bg/80 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-full bg-white/10 flex items-center justify-center text-sm font-semibold">
          H
        </div>
        <div class="flex flex-col leading-tight">
          <span class="font-semibold tracking-wide">HANSORA AI</span>
          <span class="text-xs text-zinc-400">Telegram Mini App • Midjourney Video</span>
        </div>
      </div>
      <div class="flex items-center gap-3 text-sm">
        <span class="text-zinc-400 hidden sm:inline">Credits</span>
        <span id="navCredits" class="px-2 py-1 rounded-full border border-white/10 bg-black/40 text-white/90 text-sm">0⚡</span>
      </div>
    </div>
  </header>

  <main class="flex-1">
    <section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
      <div class="grid md:grid-cols-2 gap-6 items-start">
        <!-- Left: form -->
        <div class="rounded-2xl p-5 border border-white/10 shadow-soft bg-white/5">
          <h1 class="text-2xl font-bold">
            Midjourney — Image → Video
            <span class="ml-1 text-xs text-zinc-400 align-middle">(≈5s)</span>
          </h1>
          <p class="mt-1 text-sm text-zinc-400">
            Upload <b>1 image</b>, write your prompt and tap Run. Result will be sent to your Telegram chat.
          </p>

          <div class="mt-4 space-y-3">
            <div>
              <label class="text-xs text-zinc-400">Select image (jpeg/png/webp, ≤10MB)</label>
              <input id="image" type="file" accept="image/*" class="mt-1 block w-full rounded-lg border border-white/10 bg-white/5 px-3 py-2 outline-none text-sm input-dark" />
              <div id="thumbs" class="mt-2 flex gap-2 flex-wrap"></div>
            </div>

            <div class="hidden" aria-hidden="true">
              <label class="text-xs text-zinc-400">Aspect ratio</label>
              <select id="ratio" class="mt-1 block w-full rounded-lg border border-white/10 bg-white/5 px-3 py-2 outline-none text-sm input-dark">
                <option value="1:1" selected>1:1</option>
                <option value="2:3">2:3 (portrait)</option>
                <option value="3:2">3:2 (landscape)</option>
                <option value="9:16">9:16 (vertical)</option>
                <option value="16:9">16:9 (wide)</option>
              </select>
            </div>

            <div>
              <label class="text-xs text-zinc-400">Prompt</label>
              <textarea id="prompt" placeholder="Describe motion, camera movement and style…" class="mt-1 block w-full rounded-lg border border-white/10 bg-white/5 text-sm/relaxed input-dark resize-none max-h-60 px-3 py-2 outline-none min-h-[120px]"></textarea>
            </div>

            <button id="runBtn" type="button" class="w-full rounded-xl btn px-3 py-2 text-sm font-semibold" onclick="__run()" disabled>
              Run (cost: 2⚡)
            </button>
            <div id="status" class="mt-2 text-sm"></div>
          </div>
        </div>

        <!-- Right: info -->
        <div class="rounded-2xl p-5 border border-white/10 shadow-soft bg-white/5">
          <h3 class="text-lg font-semibold">How it works</h3>
          <p class="text-xs text-zinc-400">
            This mini app uses your Hansora credits that were passed from Telegram. If you don’t have enough credits,
            the generation will not start and nothing will be charged.
          </p>
          <ul class="mt-3 space-y-2 text-xs text-zinc-400">
            <li>• Cost per run: <b>2⚡</b></li>
            <li>• If submission fails, credits are immediately restored in this mini app.</li>
            <li>• When the video is ready, you will get it directly in your Telegram chat with Hansora bot.</li>
          </ul>
          <div class="mt-4 rounded-xl border border-white/10 bg-black/20 px-3 py-2 text-xs text-zinc-400">
            <p><b>Tip:</b> Make sure you opened this mini app from your Hansora Telegram bot so your credits &amp; Telegram ID are attached correctly.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="border-t border-base-line/60 mt-4">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 text-xs text-zinc-500 flex flex-col sm:flex-row items-center justify-between gap-3">
      <p>© <span id="y"></span> HANSORA AI — All rights reserved.</p>
      <div class="flex items-center gap-4">
        <span class="text-zinc-500">Telegram Mini App</span>
      </div>
    </div>
  </footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
    window.__MJ_BUSY = false;

    const CALLBACK_URL = 'https://hook.eu2.make.com/s01gicgqpa42k1jwdoyli6puzr7djoh1';

    const params = new URLSearchParams(window.location.search);
    const tgId = params.get('tg_id') || params.get('telegram_id') || '';

    let startingCredits = parseFloat(params.get('credits') || '0');
    if (!isFinite(startingCredits) || startingCredits < 0) startingCredits = 0;
    let currentCredits = startingCredits;

    const imageEl = document.getElementById('image');
    const thumbsEl = document.getElementById('thumbs');
    const promptEl = document.getElementById('prompt');
    const ratioEl = document.getElementById('ratio');
    const runBtn = document.getElementById('runBtn');
    const statusEl = document.getElementById('status');

    function updateCreditsUI() {
      const nav = document.getElementById('navCredits');
      if (nav) nav.textContent = String(currentCredits) + '⚡';
    }

    function showStatus(msg, cls) {
      if (!statusEl) return;
      statusEl.textContent = msg;
      statusEl.className = 'mt-2 text-sm ' + (cls || '');
    }

    function currentCost() { return 2; }
    function repaintCost() {
      if (runBtn) runBtn.textContent = 'Run (cost: ' + currentCost() + '⚡)';
    }
    repaintCost();
    updateCreditsUI();

    // Enable button only if we have some credits info
    if (currentCredits >= 0 && runBtn) {
      runBtn.disabled = false;
    }

    // Image preview (single)
    let __lastObjURL = null;
    function clearImageSelection() {
      try { if (__lastObjURL) { URL.revokeObjectURL(__lastObjURL); __lastObjURL = null; } } catch (e) {}
      if (imageEl) imageEl.value = '';
      if (thumbsEl) thumbsEl.innerHTML = '';
    }

    if (imageEl) {
      imageEl.addEventListener('change', () => {
        if (!thumbsEl) return;
        thumbsEl.innerHTML = '';
        try { if (__lastObjURL) { URL.revokeObjectURL(__lastObjURL); __lastObjURL = null; } } catch (e) {}
        const f = imageEl.files[0];
        if (!f) return;
        const u = URL.createObjectURL(f);
        __lastObjURL = u;
        const img = new Image();
        img.src = u;
        img.className = 'block w-full max-h-56 object-contain rounded-lg border border-white/10 bg-black/20';
        const wrap = document.createElement('div');
        wrap.className = 'relative inline-block';
        const del = document.createElement('button');
        del.type = 'button';
        del.className = 'absolute -top-2 -right-2 h-7 w-7 rounded-full bg-black/80 text-white hover:bg-black/90 flex items-center justify-center';
        del.innerHTML = '&times;';
        del.onclick = clearImageSelection;
        wrap.appendChild(img);
        wrap.appendChild(del);
        thumbsEl.appendChild(wrap);
      });
    }

    async function uploadImageAndGetUrl(f, ownerId) {
      const origName = f.name || 'image.jpg';
      const type = (f.type || 'image/jpeg').toLowerCase();
      const safeExt = type.includes('png')
        ? '.png'
        : (type.includes('jpeg') || type.includes('jpg'))
          ? '.jpg'
          : type.includes('webp')
            ? '.webp'
            : '.jpg';
      const base = origName.replace(/\.[^./\\]+$/, '');
      const filename = `${Date.now()}-${base}${safeExt}`;

      const signResp = await fetch('/.netlify/functions/sign-upload', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-USER-ID': ownerId || ''
        },
        body: JSON.stringify({ filename, mime: type })
      });
      const signJson = await signResp.json().catch(() => null);
      if (!signResp.ok || !signJson || !signJson.uploadUrl || !signJson.publicUrl) {
        throw new Error((signJson && signJson.error) || 'sign-upload failed');
      }

      const putResp = await fetch(signJson.uploadUrl, {
        method: 'PUT',
        headers: { 'Content-Type': type },
        body: f
      });
      if (!putResp.ok) {
        throw new Error('Upload PUT failed');
      }

      try { await fetch(signJson.publicUrl, { method: 'HEAD', cache: 'no-store' }); } catch (e) {}

      return signJson.publicUrl;
    }

    window.__run = async function () {
      if (window.__MJ_BUSY) return;
      if (!tgId) {
        alert('Missing Telegram user id in URL (tg_id). Please open this from the Hansora bot.');
        return;
      }

      const files = imageEl ? Array.prototype.slice.call(imageEl.files, 0, 1) : [];
      const hasImage = files.length === 1;
      const _prompt = (promptEl && promptEl.value ? promptEl.value : '').trim();

      if (!hasImage || !_prompt) {
        showStatus('Please upload 1 image and enter a prompt (both required).', 'text-rose-300');
        return;
      }

      const cost = currentCost();
      if (currentCredits < cost) {
        showStatus('Not enough credits (need ' + cost + ').', 'text-rose-300');
        return;
      }

      if (files[0].size > 10 * 1024 * 1024) {
        alert('File too large: ' + files[0].name);
        return;
      }

      window.__MJ_BUSY = true;
      if (runBtn) runBtn.disabled = true;
      showStatus('Uploading image…', 'text-sky-300');

      const prevCredits = currentCredits;

      try {
        const imageUrl = await uploadImageAndGetUrl(files[0], tgId);
        const aspectRatio = ratioEl ? (ratioEl.value || '1:1') : '1:1';

        // Deduct locally
        currentCredits = +(currentCredits - cost).toFixed(2);
        if (currentCredits < 0) currentCredits = 0;
        updateCreditsUI();

        showStatus('Submitting job…', 'text-sky-300');

        const payload = {
          telegram_id: tgId,
          prompt: _prompt,
          imageUrl,
          aspectRatio,
          cost,
          credits_before: prevCredits,
          credits_after: currentCredits,
          source: 'midvideo_miniapp'
        };

        const resp = await fetch(CALLBACK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          currentCredits = prevCredits;
          updateCreditsUI();
          let txt = '';
          try { txt = await resp.text(); } catch (e) {}
          throw new Error('Submit failed: ' + (txt || resp.status));
        }

        showStatus('✅ Submitted. Your video will be sent to your Telegram chat when it is ready.', 'text-emerald-300');
      } catch (e) {
        currentCredits = prevCredits;
        updateCreditsUI();
        showStatus('❌ ' + (e && e.message ? e.message : String(e)), 'text-rose-300');
      } finally {
        window.__MJ_BUSY = false;
        if (runBtn) runBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
