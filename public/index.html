<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nano Banana — Image-to-Image</title>

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src * data: blob:;
                 connect-src 'self' https://api.kie.ai https://kieai.redpandaai.co https://hook.make.com;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline' https://unpkg.com">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- EXIF (kept; not required now) -->
  <script src="https://unpkg.com/exifr/dist/lite.umd.js"></script>

  <!-- HEIC→JPEG converter (the ONLY transform we keep) -->
  <script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>
  <script>
    // Only convert HEIC/HEIF to JPEG. No crop, no rotate, no resize.
    async function ensureSupported(file){
      const t = (file.type || '').toLowerCase();
      if (t === 'image/heic' || t === 'image/heif' || t === 'image/heif-sequence') {
        const base = (file.name?.replace(/\.[^.]+$/, '') || 'image');
        const blob = await heic2any({ blob: file, toType: 'image/jpeg', quality: 0.92 });
        if (!blob || !blob.size) throw new Error('HEIC/HEIF conversion failed');
        return new File([blob], base + '.jpg', { type: 'image/jpeg' });
      }
      return file;
    }
  </script>

  <style>
    body { background:#0b0b0f; color:#eaeaf0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .wrap { max-width:880px; margin:40px auto; padding:24px; background:#14141b; border-radius:16px; box-shadow:0 8px 28px rgba(0,0,0,.45); }
    h1 { font-weight:700; font-size:24px; margin:0 0 12px; }
    .row{display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap}
    .col{flex:1 1 320px}
    label{display:block; font-size:13px; opacity:.85; margin-bottom:6px}
    input[type="file"], textarea, select { width:100%; background:#0f0f15; color:#eaeaf0; border:1px solid #262634; border-radius:12px; padding:10px 12px; }
    textarea{min-height:120px; resize:vertical}
    button{width:100%; padding:12px 16px; background:#6b5bd1; color:#fff; border:0; border-radius:12px; font-weight:600; cursor:pointer}
    button[disabled]{opacity:.6; cursor:not-allowed}
    #thumbs{display:flex; gap:8px; flex-wrap:wrap}
    .thumb{margin-top:8px; width:160px; height:160px; object-fit:cover; border-radius:10px; border:1px solid #262634}
    details{margin-top:16px; background:#0f0f15; border:1px solid #262634; border-radius:12px; padding:10px 12px}
    pre{white-space:pre-wrap; word-break:break-word; margin:0}

    .banner{margin-top:12px; padding:12px 14px; border-radius:12px; border:1px solid transparent; font-weight:600}
    .banner.ok{background:#0f1a12; border-color:#1f6d3d; color:#b9f3cf}
    .banner.err{background:#1a1110; border-color:#a24a4a; color:#ffd1d1}
  </style>

  <!-- Supabase client for direct Storage upload (Nano Banana 1:1 upload path) -->
  
  <script>
    const SUPABASE_URL  = 'https://qmaealblegvcwodlmeht.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtYWVhbGJsZWd2Y3dvZGxtZWh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MjkzNzMsImV4cCI6MjA3NDIwNTM3M30.bUV6W0zBtkd_6gtfPGBSpskybUmpLC-1znljoDpYy4c';
    const SUPA_BUCKET = 'downloads'; // uses the same public bucket as website
    function supaPublicUrl(path){ return `${SUPABASE_URL}/storage/v1/object/public/${SUPA_BUCKET}/${path}`; }
    function ensureSupa(){
      if (!window.supabase || !window.supabase.createClient) throw new Error('Supabase library not loaded');
      if (!window.__supa) { window.__supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON); }
      return window.__supa;
    }
  </script>
</head>
<body>
  <noscript><div style="background:#ffdbdb;color:#300;padding:10px;border-radius:8px">
    JavaScript is disabled. The Run button won’t work.
  </div></noscript>

  <div class="wrap">
    <h1>Nano Banana — Image-to-Image</h1>

    <div class="row">
      <div class="col">
        <label for="files">Select 1–4 images (jpeg/png/webp, ≤10MB each)</label>
        <input id="files" type="file" accept="image/*" multiple />
        <div id="thumbs"></div>
      </div>

      <div class="col">
        <label for="prompt">Prompt</label>
        <textarea id="prompt" placeholder="Describe the edit or style…"></textarea>
        <div style="height:10px"></div>
        <label for="format">Output format</label>
        <select id="format">
          <option value="png" selected>PNG</option>
          <option value="jpeg">JPEG</option>
        </select>

        <!-- Image size (KIE tokens) -->
        <div style="height:10px"></div>
        <label for="imageSize">Image size</label>
        <select id="imageSize">
          <option value="auto" selected>Auto</option>
          <option value="1:1">Square (1:1)</option>
          <option value="3:4">Portrait 3:4</option>
          <option value="9:16">Portrait 9:16</option>
          <option value="4:3">Landscape 4:3</option>
          <option value="16:9">Landscape 16:9</option>
        </select>

        <div style="height:14px"></div>
        <button id="runBtn" type="button" onclick="window.__run && window.__run()">Run</button>
        <div id="status" class="banner" role="status" aria-live="polite" hidden></div>
      </div>
    </div>

    <details style="display:none">
      <summary>Debug</summary>
      <pre id="debug">BOOT: page parsed.</pre>
    </details>
  </div>

<script>
const dbg = document.getElementById('debug');
const log = (...a) => { dbg.textContent += '\n' + a.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(' '); };
window.addEventListener('error', e => log('Window error:', e.message));
window.addEventListener('unhandledrejection', e => log('Unhandled promise:', String(e.reason)));

const filesEl = document.getElementById('files');
const thumbsEl= document.getElementById('thumbs');
const promptEl= document.getElementById('prompt');
const formatEl= document.getElementById('format');
const imageSizeEl = document.getElementById('imageSize');
const runBtn  = document.getElementById('runBtn');
const statusEl= document.getElementById('status');

function showStatus(msg, kind){
  statusEl.textContent = msg;
  statusEl.className = 'banner ' + (kind === 'ok' ? 'ok' : 'err');
  statusEl.hidden = false;
}

filesEl.addEventListener('change', () => {
  thumbsEl.innerHTML = '';
  [...filesEl.files].slice(0,4).forEach(f=>{
    const url = URL.createObjectURL(f);
    const img = document.createElement('img');
    img.src = url; img.className = 'thumb';
    thumbsEl.appendChild(img);
  });
});

function newRunId(userId){
  const r = crypto.getRandomValues(new Uint32Array(1))[0].toString(36);
  return `${userId}-${Date.now()}-${r}`;
}

/* NO-OP: keep signature so rest of code is unchanged */
async function normalizeIfRotated(file) { return file; }

/* upload (HEIC convert only; no crop/rotate/resize) */

async function uploadViaFn(file, rid, index){
  // Direct REST upload to Supabase Storage (no SDK). Same 1:1 behavior.
  // Build deterministic object path
  const d = new Date();
  const yr = d.getUTCFullYear();
  const mo = String(d.getUTCMonth()+1).padStart(2,'0');
  const safeBase = (file.name || 'image').replace(/[^a-z0-9_.-]/gi,'_').toLowerCase();
  const path = `bot/${yr}/${mo}/${rid}/${index}-${safeBase}`;

  // PUT object via Storage REST
  const endpoint = `${SUPABASE_URL}/storage/v1/object/${encodeURIComponent(SUPA_BUCKET)}/${encodeURIComponent(path)}`;
  const res = await fetch(endpoint, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${SUPABASE_ANON}`,
      'apikey': SUPABASE_ANON,
      'Cache-Control': 'no-cache',
      // let browser set correct content-type for the binary body when using FormData; otherwise set file.type
      'Content-Type': file.type || 'application/octet-stream'
    },
    body: file
  });
  if (!res.ok){
    const txt = await res.text().catch(()=>'');
    throw new Error(`Supabase upload failed: ${res.status} ${txt}`);
  }

  const url = supaPublicUrl(path);
  try { await fetch(url, { method:'HEAD', cache:'no-store' }); } catch {}
  return url;
}
;
</script>
</body>
</html>
