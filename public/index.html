<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nano Banana – Edit</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#0b0c10; --card:#111318; --text:#f1f5f9; --muted:#9aa0a6; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:860px; margin:20px auto; padding:16px; }
    .card{ background:var(--card); border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1{ margin:6px 0 14px; font-size:22px; }
    label{ display:block; margin:10px 0 6px; color:var(--muted); font-size:13px; }
    input[type="file"], textarea, select {
      width:100%; padding:12px; background:#0e1117; color:var(--text);
      border:1px solid #1f2635; border-radius:10px;
    }
    textarea{ min-height:110px; resize:vertical; }
    button{
      background:#6c5ce7; color:#fff; border:0; padding:12px 16px;
      border-radius:12px; cursor:pointer; font-weight:600;
      box-shadow:0 6px 18px rgba(108,92,231,.35);
    }
    button[disabled]{ opacity:.6; cursor:not-allowed; box-shadow:none; }
    .thumbs{ display:grid; grid-template-columns:repeat(auto-fill,minmax(130px,1fr)); gap:10px; margin-top:10px; }
    .thumbs img{ width:100%; height:110px; object-fit:cover; border-radius:10px; border:1px solid #232a3d; }
    .row{ display:flex; gap:10px; align-items:center; }
    .row>*{ flex:1; }
    .hint{ color:var(--muted); font-size:12px; margin-top:6px; }
    .results{ display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:12px; margin-top:12px; }
    .results img{ width:100%; border-radius:12px; border:1px solid #232a3d; }
    pre{ background:#0d1016; color:#cbd5e1; padding:10px; border-radius:10px; overflow:auto; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Nano Banana – Image Edit</h1>
      <label>Select 1–4 images (jpeg/png/webp, ≤10MB each)</label>
      <input id="fileInput" type="file" accept="image/*" multiple />
      <div id="thumbs" class="thumbs"></div>
      <label>Prompt</label>
      <textarea id="prompt" placeholder="Describe the edit you want..."></textarea>
      <div class="row" style="margin-top:10px;">
        <select id="format">
          <option value="png">PNG</option>
          <option value="jpeg">JPEG</option>
        </select>
        <button id="runBtn">Run</button>
      </div>
      <div id="status" class="hint"></div>
      <div id="results" class="results"></div>
      <details style="margin-top:12px;">
        <summary>Debug</summary>
        <pre id="debug"></pre>
      </details>
    </div>
  </div>

<script>
(function(){
  try{ Telegram?.WebApp?.ready(); Telegram?.WebApp?.expand(); }catch(e){}
  const fileInput = document.getElementById('fileInput');
  const thumbs = document.getElementById('thumbs');
  const promptEl = document.getElementById('prompt');
  const formatEl = document.getElementById('format');
  const runBtn = document.getElementById('runBtn');
  const resultsEl = document.getElementById('results');
  const statusEl = document.getElementById('status');
  const debugEl = document.getElementById('debug');

  let selected = [];

  fileInput.addEventListener('change', () => {
    selected = Array.from(fileInput.files || []).slice(0,4);
    thumbs.innerHTML='';
    selected.forEach(f => {
      const url = URL.createObjectURL(f);
      const img = document.createElement('img');
      img.src = url;
      thumbs.appendChild(img);
    });
  });

  runBtn.addEventListener('click', async () => {
    try{
      if(!selected.length){ alert('Please choose 1–4 images.'); return; }
      runBtn.disabled = true; resultsEl.innerHTML=''; statusEl.textContent='Uploading...';

      const filesPayload = await Promise.all(selected.map(f => fileToBase64(f)));

      // UPDATED: show real error message from the upload function
      const upRes = await fetch('/.netlify/functions/upload', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ files: filesPayload })
      });
      if(!upRes.ok){
        const msg = await upRes.text();
        throw new Error(`Upload failed: ${msg}`);
      }
      const { urls } = await upRes.json();

      statusEl.textContent='Calling Nano Banana...';
      const body = {
        image_urls: urls,
        output_format: formatEl.value,
        prompt: promptEl.value || ''
      };
      const apiRes = await fetch('/.netlify/functions/run-nano-banana',{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      const data = await apiRes.json();
      statusEl.textContent = apiRes.ok ? 'Done' : 'API error';

      const imgs = extractImageUrls(data);
      imgs.forEach(u => {
        const img = document.createElement('img');
        img.src = u;
        resultsEl.appendChild(img);
      });
      debugEl.textContent = JSON.stringify(data,null,2);
    }catch(err){
      alert(err.message || 'Error');
    }finally{
      runBtn.disabled = false;
    }
  });

  function fileToBase64(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = ()=>{
        const base64 = String(reader.result).split(',')[1];
        resolve({ name:file.name, type:file.type, data: base64 });
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function extractImageUrls(obj){
    const s = JSON.stringify(obj);
    const re = /(https?:\/\/[^"\s]+\.(?:png|jpg|jpeg|webp))/gi;
    const out = []; let m;
    while((m = re.exec(s))) out.push(m[1]);
    return Array.from(new Set(out));
  }
})();
</script>
</body>
</html>
