<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HANSORA • Kling v2.1 Pro (Image → Video) • Telegram</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='16' fill='%23111827'/%3E%3Ctext x='50%25' y='52%25' font-size='32' text-anchor='middle' fill='white' font-family='Arial'%3EH%3C/text%3E%3C/svg%3E" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --base-bg:#0b0d13;
      --base-line:#1a1f2b;
      --brand:#6366f1;
    }
    body{
    .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .input-dark{background:rgba(255,255,255,.05)!important;color:#e5e7eb!important;border:1px solid rgba(255,255,255,.12)!important}
    .input-dark::placeholder{color:#9ca3af}
    select.input-dark option{background:#0b0d13;color:#e5e7eb}
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(99,102,241,.15), transparent 60%),
        radial-gradient(1200px 600px at 100% 100%, rgba(56,189,248,.12), transparent 60%),
        var(--base-bg);
      color:#e5e7eb;
    }
    .bg-base-bg{background:var(--base-bg)}
    .border-base-line{border-color:var(--base-line)}
    .btn{
      background:linear-gradient(135deg,#4f46e5,#6366f1);
      color:white;
    }
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-base-bg">
  <header class="border-b border-base-line/60">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <div class="h-8 w-8 rounded-2xl bg-indigo-500 flex items-center justify-center text-sm font-bold shadow-lg shadow-indigo-500/40">
          H
        </div>
        <div class="flex flex-col leading-tight">
          <span class="text-sm font-semibold text-white">Hansora AI</span>
          <span class="text-xs text-zinc-400">Kling v2.1 Pro Image → Video</span>
        </div>
      </div>
      <div class="flex items-center gap-3 text-xs">
        <div class="px-3 py-1 rounded-full border border-base-line bg-black/40">
          <span class="text-zinc-400">Credits:</span>
          <span id="creditsDisplay" class="font-semibold text-emerald-300 ml-1">0⚡</span>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-1">
    <div class="max-w-4xl mx-auto px-4 py-6 space-y-6">
      <section class="rounded-2xl p-5 border border-white/10 shadow-soft bg-white/5 space-y-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h1 class="text-lg md:text-xl font-semibold text-white">
              Kling v2.1 Pro (Image → Video)
            </h1>
            <p class="text-xs md:text-sm text-zinc-400 mt-1">
              Upload 1 or 2 images (start & optional end frame) + prompt, and get a short AI video.
            </p>
          </div>
        </div>

        <div class="grid md:grid-cols-[1.1fr,0.9fr] gap-4 md:gap-6 items-start">
          <div class="space-y-4">
            
            <div class="space-y-2">
              <label class="block text-xs font-medium text-zinc-300 mb-1">Image <span class="text-rose-400">*</span></label>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="space-y-2">
                  <div class="text-[11px] text-zinc-400">Start Frame (required)</div>
                  <input
                    id="startFrameInput"
                    type="file"
                    accept="image/*"
                    class="input-dark block w-full text-xs file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-indigo-500 file:text-white hover:file:bg-indigo-400"
                  />
                  <div id="startThumb" class="mt-2 flex gap-2 flex-wrap"></div>
                </div>
                <div class="space-y-2">
                  <div class="text-[11px] text-zinc-400">End Frame (optional)</div>
                  <input
                    id="endFrameInput"
                    type="file"
                    accept="image/*"
                    class="input-dark block w-full text-xs file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-indigo-500 file:text-white hover:file:bg-indigo-400"
                  />
                  <div id="endThumb" class="mt-2 flex gap-2 flex-wrap"></div>
                </div>
              </div>
              <p class="text-[11px] text-zinc-500">
                Max size 10MB per image. Start frame is required. End frame is optional.
              </p>
            </div>

            <div class="space-y-2">
              <label class="block text-xs font-medium text-zinc-300 mb-1">Prompt (required)</label>
              <textarea
                id="promptInput"
                rows="4"
                class="input-dark w-full text-xs rounded-xl px-3 py-2 text-zinc-100 placeholder:text-zinc-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                placeholder="Describe the scene and motion. Example: cinematic shot of a city street at night, slow camera move, neon lights, dramatic mood..."></textarea>
              <p class="text-[11px] text-zinc-500">
                Required. If you upload an image, describe how it should move. If no image, describe the whole video.
              </p>
            </div>

            <div class="space-y-2">
              <label for="durationSelect" class="block text-xs font-medium text-zinc-300 mb-1">Video duration</label>
              <select
                id="durationSelect"
                class="input-dark w-full text-xs rounded-xl px-3 py-2 text-zinc-100 focus:outline-none focus:ring-1 focus:ring-indigo-500"
              >
                <option value="5" selected>5s (default)</option>
                <option value="10">10s</option>
              </select>
            </div>

            <div class="space-y-2">
              <button
                id="runBtn"
                class="btn w-full rounded-2xl px-4 py-3 text-sm font-semibold shadow-lg shadow-indigo-500/40">
                Run (cost: 5⚡)
              </button>
              <p id="statusText" class="text-[11px] text-zinc-500">
                Ready.
              </p>
            </div>
            <div id="successBox" class="mt-3 hidden">
              <div class="rounded-2xl border border-emerald-500 bg-emerald-900/80 px-4 py-3 text-emerald-50 text-sm md:text-base leading-snug">
                <div class="flex items-start gap-2">
                  <div class="text-2xl">✅</div>
                  <div id="successText" class="flex-1"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="space-y-3">
            <div class="rounded-2xl border border-base-line bg-black/40 p-3 md:p-4">
              <h2 class="text-xs font-semibold text-zinc-200 mb-1">Instructions</h2>
              <ol class="list-decimal list-inside text-[11px] text-zinc-400 space-y-1.5">
                <li>Upload a start frame image (required).</li>
                <li>Optionally upload an end frame image.</li>
                <li>Click Run button.</li>
                <li>If you have enough credits, the result will be sent to your bot's chat.</li>
              </ol>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  
  <script>
    const COST_5S = 5;
    const COST_10S = 9;

    let telegramId = "";
    let credits = 0;
    let mode = "";
    let leng = "";

    const creditsDisplay = document.getElementById("creditsDisplay");
    const statusText = document.getElementById("statusText");
    const successBox = document.getElementById("successBox");
    const successText = document.getElementById("successText");
    const runBtn = document.getElementById("runBtn");
    const promptInput = document.getElementById("promptInput");
    const startFrameInput = document.getElementById("startFrameInput");
    const endFrameInput = document.getElementById("endFrameInput");
    const startThumb = document.getElementById("startThumb");
    const endThumb = document.getElementById("endThumb");
    const durationSelect = document.getElementById("durationSelect");

    let startObjURL = null;
    let endObjURL = null;

    function setStatus(msg, tone) {
      statusText.textContent = msg;
      statusText.className = "text-[11px] " + (tone || "text-zinc-500");
    }

    function getCurrentCost() {
      if (!durationSelect) return COST_5S;
      return (durationSelect.value === "10") ? COST_10S : COST_5S;
    }

    function updateRunButtonLabel() {
      if (!runBtn) return;
      const c = getCurrentCost();
      runBtn.textContent = "Run (cost: " + c + "⚡)";
    }

    function repaintCredits() {
      creditsDisplay.textContent = credits.toFixed(1).replace(/\.0$/, "") + "⚡";
    }

    function parseQueryParams() {
      const url = new URL(window.location.href);
      telegramId = url.searchParams.get("telegram_id") || "";
      const cStr = url.searchParams.get("credits") || "0";
      const parsed = Number(cStr);
      credits = Number.isFinite(parsed) ? parsed : 0;
      repaintCredits();

      mode = url.searchParams.get("mode") || url.searchParams.get("modul") || "";
      leng = url.searchParams.get("leng") || url.searchParams.get("lang") || "";

      if (!telegramId) {
        setStatus("Missing telegram_id in URL. Please open this page from the bot.", "text-rose-300");
        runBtn.disabled = true;
      }
    }

    function revokeUrl(urlRef) {
      try {
        if (urlRef) URL.revokeObjectURL(urlRef);
      } catch {}
    }

    function clearStartFrame() {
      revokeUrl(startObjURL);
      startObjURL = null;
      if (startFrameInput) startFrameInput.value = "";
      if (startThumb) startThumb.innerHTML = "";
    }

    function clearEndFrame() {
      revokeUrl(endObjURL);
      endObjURL = null;
      if (endFrameInput) endFrameInput.value = "";
      if (endThumb) endThumb.innerHTML = "";
    }

    function setupPreview(inputEl, thumbEl, kind) {
      if (!inputEl || !thumbEl) return;
      inputEl.addEventListener("change", () => {
        if (kind === "start") {
          clearStartFrame();
        } else {
          clearEndFrame();
        }

        const f = inputEl.files && inputEl.files[0];
        if (!f) return;

        const u = URL.createObjectURL(f);
        if (kind === "start") startObjURL = u; else endObjURL = u;

        const img = new Image();
        img.src = u;
        img.className = "block w-full max-h-56 object-contain rounded-lg border border-white/10 bg-black/20";

        const wrap = document.createElement("div");
        wrap.className = "relative inline-block";

        const del = document.createElement("button");
        del.type = "button";
        del.className = "absolute -top-2 -right-2 h-7 w-7 rounded-full bg-black/70 border border-white/20 text-white/80 hover:text-white hover:bg-black/90 flex items-center justify-center";
        del.innerHTML = "\u00d7";
        del.onclick = () => {
          if (kind === "start") clearStartFrame(); else clearEndFrame();
        };

        wrap.appendChild(img);
        wrap.appendChild(del);
        thumbEl.appendChild(wrap);
      });
    }

    async function signUpload(filename, mime) {
      const resp = await fetch("/.netlify/functions/sign-upload", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-USER-ID": telegramId || "tg-anon"
        },
        body: JSON.stringify({ filename, mime })
      });
      const data = await resp.json().catch(() => null);
      if (!resp.ok || !data || !data.uploadUrl || !data.publicUrl) {
        throw new Error((data && data.error) || "sign-upload failed");
      }
      return data;
    }

    async function uploadImage(file, label) {
      const origName = file.name || (label + ".jpg");
      const type = (file.type || "image/jpeg").toLowerCase();
      const safeExt = type.includes("png") ? ".png"
        : (type.includes("jpeg") || type.includes("jpg")) ? ".jpg"
        : (type.includes("webp") ? ".webp" : ".jpg");
      const base = origName.replace(/\.[^./\\\\]+$/, "");
      const filename = Date.now() + "-" + label + "-" + base + safeExt;

      const signJson = await signUpload(filename, type || "image/jpeg");

      const putResp = await fetch(signJson.uploadUrl, {
        method: "PUT",
        headers: { "Content-Type": type || "image/jpeg" },
        body: file
      });
      if (!putResp.ok) {
        throw new Error("Upload failed");
      }

      try {
        await fetch(signJson.publicUrl, { method: "HEAD", cache: "no-store" });
      } catch {}

      return signJson.publicUrl;
    }

    async function handleRun() {
      if (successBox) successBox.classList.add("hidden");
      if (runBtn.disabled) return;

      if (!telegramId) {
        setStatus("Missing telegram_id, cannot continue.", "text-rose-300");
        return;
      }

      const startFiles = Array.from(startFrameInput.files || []);
      const endFiles = Array.from(endFrameInput.files || []);

      if (!startFiles.length) {
        setStatus("Please upload a start frame image.", "text-rose-300");
        return;
      }
      if (startFiles.length > 1) {
        setStatus("Please upload only 1 start frame image.", "text-rose-300");
        return;
      }
      if (endFiles.length > 1) {
        setStatus("Please upload only 1 end frame image.", "text-rose-300");
        return;
      }

      const prompt = (promptInput.value || "").trim();
      if (!prompt) {
        setStatus("Please enter a prompt.", "text-rose-300");
        return;
      }

      const startFile = startFiles[0];
      const endFile = endFiles[0];

      if (startFile.size > 10 * 1024 * 1024 || (endFile && endFile.size > 10 * 1024 * 1024)) {
        setStatus("File too large (max 10MB per image).", "text-rose-300");
        return;
      }

      const cost = getCurrentCost();
      if (credits < cost) {
        setStatus("Not enough credits (need " + cost + ").", "text-rose-300");
        return;
      }

      // Deduct credits live in the mini app
      credits -= cost;
      repaintCredits();

      runBtn.disabled = true;
      runBtn.textContent = "Working…";

      let firstFrameUrl = "";
      let lastFrameUrl = "";
      const duration = durationSelect ? (durationSelect.value === "10" ? 10 : 5) : 5;

      try {
        setStatus("Uploading start frame…", "text-zinc-400");
        firstFrameUrl = await uploadImage(startFile, "start");

        if (endFile) {
          setStatus("Uploading end frame…", "text-zinc-400");
          lastFrameUrl = await uploadImage(endFile, "end");
        }

        setStatus("Submitting Kling v2.1 Pro job…", "text-zinc-400");

        const resp = await fetch("/.netlify/functions/run-kling21-tg", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            telegram_id: telegramId,
            credits_before: credits + cost,
            new_credits: credits,
            cost,
            duration,
            prompt,
            firstFrameUrl,
            lastFrameUrl,
            mode,
            leng
          })
        });

        const j = await resp.json().catch(() => ({}));

        if (!resp.ok || !j.submitted) {
          // Refund local credits on failure
          credits += cost;
          repaintCredits();
          const err = j && (j.error || j.message);
          throw new Error(err || "Error submitting job");
        }

        setStatus("✅ Request submitted.", "text-emerald-300");
        if (successBox && successText) {
          successBox.classList.remove("hidden");
          successText.innerHTML =
            "✦ Submitted successfully. You will receive the Kling v2.1 Pro video in Telegram when it is ready." +
            "<br/>✦ Запрос успешно принят. Вы получите видео Kling v2.1 Pro в Telegram, когда оно будет готово.";
        }
      } catch (err) {
        console.error(err);
        setStatus("Error: " + (err && err.message ? err.message : "Something went wrong."), "text-rose-300");
      } finally {
        runBtn.disabled = false;
        updateRunButtonLabel();
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      parseQueryParams();
      updateRunButtonLabel();
      if (durationSelect) {
        durationSelect.addEventListener("change", updateRunButtonLabel);
      }
      setupPreview(startFrameInput, startThumb, "start");
      setupPreview(endFrameInput, endThumb, "end");
      runBtn.addEventListener("click", () => { handleRun(); });
    });
  </script>
</body>
</html>
